---
title: "Compare_statistical_analysis"
output: html_document
---
# Packages
```{r}
library(dplyr)
library(magrittr)
library(ggplot2)
library(tidyverse)
library(plotly)
library("phyloseq")
library(ggrepel)
```

```{r}


sig_phylum_color <-
  c("#F8766D","#D89000", "#85AD00" ,"#00A5FF","#DC71FA","#00C0B8","#39B600")
            
```
# Kraken2 
### Data Wrangling to format for phyloseq analysis
```{r}
path = "/Users/rx32940/Dropbox/5.Rachel-projects/Metagenomic_Analysis/final_analysis/kraken2/"
absolute_path = paste(path,"custom/absolute/",sep="")
files <- list.files(absolute_path)


i=0

# iterate through all sample's result for Domain info
for (file in files){
  current_sample <- read.csv(paste(absolute_path,file,sep=""),sep="\t",header=FALSE)
  bacteria_profile <- current_sample %>% mutate(trimed = trimws(V6)) %>% subset(V4 == "G") %>% select(c(trimed,V2))  %>% subset(! trimed %in% "Rattus" &  ! trimed %in% "Homo")# only keep rank that has certain taxonomy
  rownames(bacteria_profile) <- NULL # reorder rownames after subsetting
  colnames(bacteria_profile) <- c("OTU",unlist(strsplit(file,".",fixed = TRUE))[1])
  
  if (i == 0){ # if is the first sample, make the table the aggregated data table
    all_samples_w_taxa <-  bacteria_profile

  } else {
    all_samples_w_taxa <- full_join(all_samples_w_taxa, bacteria_profile,by=c("OTU"))

  }
  i = i + 1
}



# make the OTU names the rownames
rownames(all_samples_w_taxa) <- all_samples_w_taxa$OTU
# write.csv(all_samples_w_taxa$OTU,paste0(path, "kraken2_genus_tax.csv"), quote=FALSE, row.names = FALSE, col.names = NA)
all_samples_w_taxa[is.na(all_samples_w_taxa)]<-0

genus_Kraken2 <- all_samples_w_taxa

```

### input into phyloseq objects
```{r}

otu_tab <- all_samples_w_taxa[,-1]
OTU <- otu_table(otu_tab,taxa_are_rows = T) # OTU table, abundance level for each taxa for each sample

# to obtain a tax table,I retrieved the lineage for all genus in bracken results
# use this tool : https://www.ncbi.nlm.nih.gov/Taxonomy/TaxIdentifier/tax_identifier.cgi
# since we only need Phylum and kingdom, next time figure out a way to query phylum and kingdom of each genus instead of query the entire lineage
tax <- read.csv("/Users/rx32940/Dropbox/5.Rachel-projects/Metagenomic_Analysis/final_analysis/kraken2/kraken_genus_lineage.csv", header = FALSE)
rownames(tax) <- rownames(otu_tab)
colnames(tax) <- c("Genus","Phylum","Domain")
TAX <- tax_table(as.matrix(tax)) # TAX table, taxonomy lineage for each taxa from the OTU table

# add sample's metadata
meta_sample <- read.csv("/Users/rx32940/Dropbox/5.Rachel-projects/Metagenomic_Analysis/final_analysis/kraken2/kraken2_sample_meta.csv")
row.names(meta_sample) <- meta_sample$X
meta_sample <- meta_sample[,-1]
sample_meta <- sample_data(meta_sample)



# merge all information together
cus_kraken2_physeq <- phyloseq(OTU,TAX,sample_meta)

library("ape")
random_tree_kraken2 = rtree(ntaxa(cus_kraken2_physeq), rooted=TRUE, tip.label=taxa_names(cus_kraken2_physeq))
# plot_bar(cus_kraken2_physeq, fill="Domain")
# plot_heatmap(cus_kraken2_physeq, taxa.label="Domain")
# plot_tree(cus_kraken2_physeq, color="Domain", shape="Tissue", size="abundance")

# merge all information together
cus_kraken2_physeq <- phyloseq(OTU,TAX,sample_meta,random_tree_kraken2)
```

### Alpha Diversity (Within Sample diversity)
- tutorial: https://grunwaldlab.github.io/analysis_of_microbiome_community_data_in_r/07--diversity_stats.html

- **Shannon**: How difficult it is to predict the identity of a randomly chosen individual.
- **Simpson**: The probability that two randomly chosen individuals are the same species.
- **Inverse Simpson**: This is a bit confusing to think about. Assuming a theoretically community where all species were equally abundant, this would be the number of species needed to have the same Simpson index value for the community being analyzed.

```{r}

library(vegan)
# margin = 2, means samples are the col names
alpha_diversity_kraken2 <- data.frame(Shannon = diversity(otu_tab, MARGIN =2, index="shannon"), Simpson = diversity(otu_tab, MARGIN =2, index="simpson"), Inverse_Simpson = diversity(otu_tab, MARGIN =2, index="invsimpson")) 

# plot Alpha diversity 
# plot Alpha diversity 
plot_richness(cus_kraken2_physeq, x= "Tissue", color="Subject",measures = c("Shannon", "Simpson", "InvSimpson"))+
  geom_point(size=5) +
   theme_classic()+
  theme(legend.key.size = unit(1.0, "cm"), legend.text = element_text(size=13),legend.title = element_text(size=14,face="bold"), strip.text = element_text(face="bold",size=12), axis.text.y = element_text(face="bold", angle=-90,size=10),axis.text.x = element_blank(),axis.title = element_blank()) + guides(color = guide_legend(override.aes = list(size=5)))
# ggsave("/Users/rachel/Dropbox/5.Rachel-projects/Metagenomic_Analysis/final_analysis/plots/alpha/kraken2_alpha.png")
alpha_diversity_kraken2
```

###Beta Diversity (between samples)
https://grunwaldlab.github.io/analysis_of_microbiome_community_data_in_r/07--diversity_stats.html
- Bray–Curtis: The sum of lesser counts for species present in both communities divided by the sum of all counts in both communities. This can be thought of as a quantitative version of the Sørensen index.
- Weighted Unifrac: The fraction of the phylogenetic tree branch lengths shared by the two communities, weighted by the counts of organisms, so more abundant organisms have a greater influence.

```{r}

# no margin option like alpha diversity, use transpose for samples as colnames
# bray-curtis
beta_dist_kraken2 <-vegdist(t(otu_tab), index="bray") # pairwise comparison between samples

# plot beta diversity using ordination, a way to display high dimensional data
# capture the information in many dimensions by in a smaller number of "artifical" dimensions
mds <- metaMDS(beta_dist_kraken2)
mds_kraken2 <- as.data.frame(mds$points)
mds_kraken2$samples <- rownames(mds_kraken2)
meta_sample$samples <- rownames(meta_sample)
mds_kraken2_meta <- left_join(meta_sample,mds_kraken2, by="samples")

ggplot(mds_kraken2_meta,aes(x=MDS1,y=MDS2,shape=samples))+
  geom_point(size=6) +
  scale_shape_manual()+
  scale_shape_manual(values = c(19,18,17,15,seq(1,12,1)))+
  # geom_label_repel(aes(label=samples),
  #                 point.padding = 0.5)+
  theme_classic()+
  theme( axis.text=element_text(size = 16), axis.title =element_text(size = 16),legend.text = element_text(size=13), legend.title = element_text(size=14, face="bold"),legend.position = "none")
ggsave("/Users/rx32940/Desktop/kraken2_beta.pdf",height = 4,width=6)
mds_kraken2_meta
```

### Differential Abundant with Deseq2
- load DESeq2 package
```{r}
library("DESeq2")

```

- differentially abundant analysis with deseq2
```{r}
desseq_kraken2 <- phyloseq_to_deseq2(cus_kraken2_physeq, ~ Tissue)
desseq_kraken2
kraken_deseq <- DESeq(desseq_kraken2, test="Wald", fitType="parametric")

# pairwise comparison between 2 tissues
Kidney_lung <- results(kraken_deseq, cooksCutoff = FALSE,contrast = c("Tissue","Kidney","Lung"))
kidney_spleen <- results(kraken_deseq, cooksCutoff = FALSE,contrast = c("Tissue","Kidney","Spleen"))
lung_spleen <- results(kraken_deseq, cooksCutoff = FALSE,contrast = c("Tissue","Lung","Spleen"))

alpha = 0.01 # significance threhold

# change pairwise comparison results for comparing two different tissues
sigtax_kraken2 <- Kidney_lung[which(Kidney_lung$padj < alpha),] # get tax below the significance thresholf
sigtax_kraken2$Genus <- rownames(sigtax_kraken2) # add a column so genus tax can combine with upper lineages

# add lineages to significant taxa
sigtax_kraken2_lineage <- left_join(as.data.frame(sigtax_kraken2), tax)
dim(sigtax_kraken2_lineage)

```

- Plot significantly abundant taxa from the samples
```{r}
# find the maximum log2fold change from deseq2 output for each cell (tapply)
x<-tapply(sigtax_kraken2_lineage$log2FoldChange,sigtax_kraken2_lineage$Phylum,function(x)max(x))
x<- sort(x,TRUE) # sort these identified phyla in descending order
# order the sig taxa base on the decreasing order for the fold of changes between tissues
sigtax_kraken2_lineage$Phylum <- factor(as.character(sigtax_kraken2_lineage$Phylum),levels = c("Spirochaetes","Proteobacteria","Tenericutes","Firmicutes","Bacteroidetes","Cyanobacteria"))
sig_phylum_color <-
  c("#F8766D","#D89000", "#85AD00" ,"#00A5FF","#DC71FA","#39B600")
kraken2_sig_phylum <- x
# perform the same ordering procedure with genus too
x<-tapply(sigtax_kraken2_lineage$log2FoldChange,sigtax_kraken2_lineage$Genus,function(x)max(x))
x<- sort(x,TRUE) # sort these identified genus in descending order
# order the sig taxa base on the decreasing order for the fold of changes between tissues
sigtax_kraken2_lineage$Genus <- factor(as.character(sigtax_kraken2_lineage$Genus),levels = names(x))
kraken2_sig_genus <- x
kraken2_diffab_plot <- ggplot(sigtax_kraken2_lineage, aes(x=Genus, y=log2FoldChange, shape= Phylum))+ geom_point(size=5) + 
  theme_classic()+
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5,size = 12, face="bold"),legend.key.size = unit(0.6, "cm"), legend.text = element_text(size=12),legend.title = element_text(size=12,face="bold"), axis.text.y = element_text(face="bold",size=10),axis.title = element_blank(), legend.position = "none")+
  scale_color_manual(values=sig_phylum_color)
kraken2_diffab_plot
# ggsave("/Users/rachel/Dropbox/5.Rachel-projects/Metagenomic_Analysis/final_analysis/plots/sigtax/kraken2_kidney_lung.png")
```

---

# Clark
## read in all the clark sample's data
```{r}
custom_path="/Users/rx32940/Dropbox/5.Rachel-projects/Metagenomic_Analysis/final_analysis/clark/"
species_path <- paste(custom_path, "species_custom/" , sep="")
files <- list.files(species_path)


i=0
for (file in files){
  sample_name <- unlist(strsplit(file, ".",fixed=T))[1]
  sample_record <- read.csv(paste(species_path, file,sep=""), header = TRUE)
  # get the domain column
  taxa_count <- sample_record  %>% select("Lineage","X","X.4","Count") %>% group_by(X.4) %>% mutate(Reads=sum(Count)) %>% select(!c(Count))
  taxa_count <- unique(taxa_count)

  colnames(taxa_count) <- c("Domain","Phylum","Genus",sample_name)
  
  taxa_count %<>% subset(Genus != "Homo" & Genus != "Rattus" & Genus != "")
  rownames(taxa_count) <- NULL # reset row number
 
  if (i == 0){
    genus_full_table <- taxa_count
  } else {
    genus_full_table <- full_join(genus_full_table, taxa_count,by = c("Domain","Phylum" ,"Genus"))
  }
  i = i + 1
}

genus_full_table[is.na(genus_full_table)] <- 0

genus_clark <- genus_full_table
```

# put clark data into phyloseq object
```{r}
# OTU table
otu_data <- genus_full_table %>% select("Genus","R22_K","R26_K","R27_K","R28_K","R22_L","R26_L","R27_L","R28_L","R22_S","R26_S","R27_S","R28_S") %>% data.frame
rownames(otu_data)<-genus_full_table$Genus
otu_data <- otu_data[,-1]
OTU <- otu_table(otu_data,taxa_are_rows = T)

# lineage table
tax_data <- genus_full_table %>% 
  select("Domain","Phylum","Genus") %>% data.frame
rownames(tax_data) <- tax_data$Genus
TAX <- tax_table(as.matrix(tax_data))

# add sample's metadata
meta_sample <- read.csv("/Users/rx32940/Dropbox/5.Rachel-projects/Metagenomic_Analysis/final_analysis/kraken2/kraken2_sample_meta.csv")
row.names(meta_sample) <- meta_sample$X
meta_sample <- meta_sample[,-1]
sample_meta <- sample_data(meta_sample)
sample_meta

# merge all information together
cus_clark_physeq <- phyloseq(OTU,TAX,sample_meta)
```

### Alpha Diversity (Within Sample diversity)
```{r}

# margin = 2, means samples are the col names
alpha_diversity_clark <- data.frame(Shannon = diversity(otu_data, MARGIN =2, index="shannon"), Simpson = diversity(otu_data, MARGIN =2, index="simpson"), Inverse_Simpson = diversity(otu_data, MARGIN =2, index="invsimpson")) 

# plot Alpha diversity 
plot_richness(cus_clark_physeq, x= "Tissue", shape ="Subject",measures = c("Shannon", "Simpson", "InvSimpson")) +
  geom_point(size=3) +
   theme_classic()+
  theme(legend.key.size = unit(1.0, "cm"), legend.text = element_text(size=13),legend.title = element_text(size=14,face="bold"), strip.text = element_text(face="bold",size=12), axis.text.y = element_text(face="bold", angle=-90,size=10),axis.text.x=element_blank(),axis.title = element_blank()) + guides(color = guide_legend(override.aes = list(size=5)))
# ggsave("/Users/rx32940/Desktop/clark_alpha.png")
alpha_diversity_clark
```

###Beta Diversity (between samples)
```{r}

# no margin option like alpha diversity, use transpose for samples as colnames
# bray-curtis
beta_dist_clark <-vegdist(t(otu_data), index="bray") # pairwise comparison between samples

# plot beta diversity using ordination, a way to display high dimensional data
# capture the information in many dimensions by in a smaller number of "artifical" dimensions
mds <- metaMDS(beta_dist_clark)
mds_clark <- as.data.frame(mds$points)
mds_clark$samples <- rownames(mds_clark)
meta_sample$samples <- rownames(meta_sample)
mds_clark_meta <- left_join(meta_sample,mds_clark, by="samples")

ggplot(mds_clark_meta,aes(x=MDS1,y=MDS2,shape=samples))+
  geom_point(size=6) +
  scale_shape_manual(values = c(19,18,17,15,seq(1,12,1)))+
  # geom_label_repel(aes(label=samples),
  #                 point.padding = 0.5)+
  theme_classic()+
  theme( axis.text=element_text(size = 16), axis.title =element_text(size = 16),legend.text = element_text(size=13), legend.title = element_text(size=14, face="bold"),legend.position = "none")
ggsave("/Users/rx32940/Desktop/clark_beta.pdf",height = 4,width = 6)
```

### Differential Abundant with Deseq2

- differentially abundant analysis with deseq2
```{r}
desseq_clark <- phyloseq_to_deseq2(cus_clark_physeq, ~ Tissue)
desseq_clark
clark_deseq <- DESeq(desseq_clark, test="Wald", fitType="parametric")

# pairwise comparison between 2 tissues
Kidney_lung <- results(clark_deseq, cooksCutoff = FALSE,contrast = c("Tissue","Kidney","Lung"))
kidney_spleen <- results(clark_deseq, cooksCutoff = FALSE,contrast = c("Tissue","Kidney","Spleen"))
lung_spleen <- results(clark_deseq, cooksCutoff = FALSE,contrast = c("Tissue","Lung","Spleen"))

alpha = 0.01 # significance threhold

# change pairwise comparison results for comparing two different tissues
sigtax_clark <- Kidney_lung[which(Kidney_lung$padj < alpha),] # get tax below the significance thresholf
sigtax_clark$Genus <- rownames(sigtax_clark) # add a column so genus tax can combine with upper lineages

# add lineages to significant taxa
clark_deseq_lineage <- left_join(as.data.frame(sigtax_clark), tax_data)
dim(clark_deseq_lineage)

```

- Plot significantly abundant taxa from the samples
```{r}
# find the maximum log2fold change from deseq2 output for each cell (tapply)
x<-tapply(clark_deseq_lineage$log2FoldChange,clark_deseq_lineage$Phylum,function(x)max(x))
x<- sort(x,TRUE) # sort these identified phyla in descending order
# order the sig taxa base on the decreasing order for the fold of changes between tissues
clark_deseq_lineage$Phylum <- factor(as.character(clark_deseq_lineage$Phylum),levels = c("Spirochaetes","Proteobacteria","Tenericutes","Firmicutes","Bacteroidetes","Peploviricota","Cyanobacteria"))
clark_sig_phylum <- x
# perform the same ordering procedure with genus too
x<-tapply(clark_deseq_lineage$log2FoldChange,clark_deseq_lineage$Genus,function(x)max(x))
x<- sort(x,TRUE) # sort these identified genus in descending order
# order the sig taxa base on the decreasing order for the fold of changes between tissues
clark_deseq_lineage$Genus <- factor(as.character(clark_deseq_lineage$Genus),levels = names(x))
clark_sig_genus <- x
sig_phylum_color <-
  c("#F8766D","#D89000", "#85AD00" ,"#00A5FF","#DC71FA","#00C0B8","#39B600")
clark_diffab_plot <-ggplot(clark_deseq_lineage, aes(x=Genus, y=log2FoldChange, shape= Phylum))+ geom_point(size=5) + 
  theme_classic()+
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5,size=12,face="bold"),legend.key.size = unit(0.6, "cm"), legend.text = element_text(size=12),legend.title = element_text(size=12,face="bold"), axis.text.y = element_text(face="bold",size=10),axis.title = element_blank(), legend.position = "none") +
  scale_color_manual(values=sig_phylum_color)
clark_diffab_plot
# ggsave("/Users/rachel/Dropbox/5.Rachel-projects/Metagenomic_Analysis/final_analysis/plots/sigtax/clark_kidney_lung.png")
```
 
---

# Clark-s 
## read in all the clarks sample's data
```{r}
custom_path="/Users/rx32940/Dropbox/5.Rachel-projects/Metagenomic_Analysis/final_analysis/clark/"
species_path <- paste(custom_path, "species_rat_spaced/" , sep="")
files <- list.files(species_path)


i=0
for (file in files){
  sample_name <- unlist(strsplit(file, ".",fixed=T))[1]
  sample_record <- read.csv(paste(species_path, file,sep=""), header = TRUE)
  # get the domain column
  taxa_count <- sample_record  %>% select("Lineage","X","X.4","Count") %>% group_by(X.4) %>% mutate(Reads=sum(Count)) %>% select(!c(Count))
  taxa_count <- unique(taxa_count)

  colnames(taxa_count) <- c("Domain","Phylum","Genus",sample_name)
  
  taxa_count %<>% subset(Genus != "Homo" & Genus != "Rattus" & Genus != "")
  rownames(taxa_count) <- NULL # reset row number
 
  if (i == 0){
    genus_full_table <- taxa_count
  } else {
    genus_full_table <- full_join(genus_full_table, taxa_count,by = c("Domain","Phylum" ,"Genus"))
  }
  i = i + 1
}

genus_full_table[is.na(genus_full_table)] <- 0
genus_clarks <- genus_full_table
```

# put clarks data into phyloseq object
```{r}
# OTU table
otu_data <- genus_full_table %>% select("Genus","R22_K","R26_K","R27_K","R28_K","R22_L","R26_L","R27_L","R28_L","R22_S","R26_S","R27_S","R28_S") %>% data.frame
rownames(otu_data)<-genus_full_table$Genus
otu_data <- otu_data[,-1]
OTU <- otu_table(otu_data,taxa_are_rows = T)

# lineage table
tax_data <- genus_full_table %>% 
  select("Domain","Phylum","Genus") %>% data.frame
rownames(tax_data) <- tax_data$Genus
TAX <- tax_table(as.matrix(tax_data))

# add sample's metadat
meta_sample <- read.csv("/Users/rx32940/Dropbox/5.Rachel-projects/Metagenomic_Analysis/final_analysis/kraken2/kraken2_sample_meta.csv")
row.names(meta_sample) <- meta_sample$X
meta_sample <- meta_sample[,-1]
sample_meta <- sample_data(meta_sample)
sample_meta

# merge all information together
cus_clarks_physeq <- phyloseq(OTU,TAX,sample_meta)
```

### Alpha Diversity (Within Sample diversity)
```{r}
# margin = 2, means samples are the col names
alpha_diversity_clarks <- data.frame(Shannon = diversity(otu_data, MARGIN =2, index="shannon"), Simpson = diversity(otu_data, MARGIN =2, index="simpson"), Inverse_Simpson = diversity(otu_data, MARGIN =2, index="invsimpson")) 
alpha_diversity_clarks
# plot Alpha diversity 
plot_richness(cus_clarks_physeq, x= "Tissue", shape ="Subject",measures = c("Shannon", "Simpson", "InvSimpson")) +
  geom_point(size=5) +
   theme_bw()+
  theme(legend.key.size = unit(1.0, "cm"), legend.text = element_text(size=13),legend.title = element_text(size=14,face="bold"), strip.text = element_text(face="bold",size=12), axis.text.y  = element_text(face="bold", angle=-90,size=10),axis.title = element_blank()) + guides(color = guide_legend(override.aes = list(size=5)))
# ggsave("/Users/rx32940/Desptop/clarks_alpha.png")

```

###Beta Diversity (between samples)
```{r}

# no margin option like alpha diversity, use transpose for samples as colnames
# bray-curtis
beta_dist_clarks <-vegdist(t(otu_data), index="bray") # pairwise comparison between samples

# plot beta diversity using ordination, a way to display high dimensional data
# capture the information in many dimensions by in a smaller number of "artifical" dimensions
mds <- metaMDS(beta_dist_clarks)
mds_clarks <- as.data.frame(mds$points)
mds_clarks$samples <- rownames(mds_clarks)
meta_sample$samples <- rownames(meta_sample)
mds_clarks_meta <- left_join(meta_sample,mds_clarks, by="samples")

ggplot(mds_clarks_meta,aes(x=MDS1,y=MDS2,shape=samples))+
 geom_point(size=6) +
  scale_shape_manual(values = c(19,18,17,15,seq(1,12,1)))+
  # geom_label_repel(aes(label=samples),
  #                 point.padding = 0.5)+
  theme_classic()+
  theme( axis.text=element_text(size = 16), axis.title =element_text(size = 16),legend.text = element_text(size=13), legend.title = element_text(size=14, face="bold"),legend.position = "none")
ggsave("/Users/rx32940/Desktop/clarks_beta.pdf",height=4,width = 6)
```

### Differential Abundant with Deseq2

- differentially abundant analysis with deseq2
```{r}
desseq_clarks <- phyloseq_to_deseq2(cus_clarks_physeq, ~ Tissue)
desseq_clarks
clarks_deseq <- DESeq(desseq_clarks, test="Wald", fitType="parametric")

# pairwise comparison between 2 tissues
Kidney_lung <- results(clarks_deseq, cooksCutoff = FALSE,contrast = c("Tissue","Kidney","Lung"))
kidney_spleen <- results(clarks_deseq, cooksCutoff = FALSE,contrast = c("Tissue","Kidney","Spleen"))
lung_spleen <- results(clarks_deseq, cooksCutoff = FALSE,contrast = c("Tissue","Lung","Spleen"))

alpha = 0.01 # significance threhold

# change pairwise comparison results for comparing two different tissues
sigtax_clarks <- Kidney_lung[which(Kidney_lung$padj < alpha),] # get tax below the significance thresholf
sigtax_clarks$Genus <- rownames(sigtax_clarks) # add a column so genus tax can combine with upper lineages

# add lineages to significant taxa
clarks_deseq_lineage <- left_join(as.data.frame(sigtax_clarks), tax_data)
dim(clarks_deseq_lineage)


```

- Plot significantly abundant taxa from the samples
```{r}
# find the maximum log2fold change from deseq2 output for each cell (tapply)
x<-tapply(clarks_deseq_lineage$log2FoldChange,clarks_deseq_lineage$Phylum,function(x)max(x))
x<- sort(x,TRUE) # sort these identified phyla in descending order
# order the sig taxa base on the decreasing order for the fold of changes between tissues
clarks_deseq_lineage$Phylum <- factor(as.character(clarks_deseq_lineage$Phylum),levels = c("Spirochaetes","Proteobacteria","Tenericutes","Firmicutes","Bacteroidetes","Peploviricota","Cyanobacteria"))
clarks_sig_phylum <- x
# perform the same ordering procedure with genus too
x<-tapply(clarks_deseq_lineage$log2FoldChange,clarks_deseq_lineage$Genus,function(x)max(x))
x<- sort(x,TRUE) # sort these identified genus in descending order
# order the sig taxa base on the decreasing order for the fold of changes between tissues
clarks_deseq_lineage$Genus <- factor(as.character(clarks_deseq_lineage$Genus),levels = names(x))
clarks_sig_genus <- x
clarks_diffab_plot <- ggplot(clarks_deseq_lineage, aes(x=Genus, y=log2FoldChange, shape= Phylum))+ geom_point(size=5) + 
  theme_classic()+
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5,size=12,face="bold"),legend.key.size = unit(0.6, "cm"), legend.text = element_text(size=12),legend.title = element_text(size=12,face="bold"), axis.text.y = element_text(face="bold", size=10),axis.title = element_blank(), legend.position = "none") +
  scale_color_manual(values=sig_phylum_color)
clarks_diffab_plot
# ggsave("/Users/rachel/Dropbox/5.Rachel-projects/Metagenomic_Analysis/final_analysis/plots/sigtax/clarks_kidney_lung.png")


```

# OVERVIEW: Comparison Between Three Softwares
## combined Genus data 
```{r}
library(dplyr)
library(ggsignif)
library(scales)
genus_Kraken2_1 <- genus_Kraken2 %>% dplyr::rename(Genus = OTU)
length(genus_Kraken2_1$Genus)
genus_Kraken2_1$software <- "Kraken2"
genus_clark_1 <- genus_clark %>% select(-c(Domain, Phylum))
length(genus_clark_1$Genus)
genus_clark_1$software <- "CLARK"
genus_clarks_1 <- genus_clarks %>% select(-c(Domain, Phylum))
genus_clarks_1$software <- "CLARK-s"
length(genus_clarks_1$Genus)

combined_software_genus <- rbind(genus_Kraken2_1, genus_clark_1, genus_clarks_1) 

genus_microbial_summary <- combined_software_genus %>% pivot_longer(c("R22_K","R26_K","R27_K","R28_K","R22_L","R26_L","R27_L","R28_L","R22_S","R26_S","R27_S","R28_S"), names_to= "samples", values_to = "Reads") %>% group_by(software, samples) %>% summarise(total_reads = sum(Reads))

ggplot(genus_microbial_summary, aes(x= software, y= `total_reads`))+
  geom_boxplot()+
  geom_point(aes(color = samples)) +
stat_signif(comparisons = list(c("Kraken2", "CLARK"), c("Kraken2", "CLARK-s"), c("CLARK","CLARK-s")),
          map_signif_level =c("***"=0.001,"**"=0.01,"*"=0.05, " "=2), test ="wilcox.test", position = "identity",
          test.args = list(paired=T, exact=TRUE), vjust=0.6,
                        textsize=6,
                        size=0.5,
                        step_increase = 0.05, na.rm = TRUE, show.legend = TRUE, fontface = "bold")+
  theme_bw()+

  theme(axis.text.x = element_text(angle=45, vjust=0.8,hjust = 0.8, size =12),axis.text.y = element_text(size=12), strip.text = element_text(size=12),axis.title = element_text(size=12), legend.text = element_text(size=12),legend.title = element_text(size=12))+
    scale_y_continuous(labels = comma)+
  labs(y="Number of Reads")

friedman.test(total_reads ~ samples | software, data = genus_microbial_summary)

```


## combined alpha diversity
```{r}
alpha_diversity_kraken2$samples <- rownames(alpha_diversity_kraken2)
alpha_diversity_kraken2$software <- "Kraken2"
alpha_diversity_clark$samples <- rownames(alpha_diversity_clark)
alpha_diversity_clark$software <- "CLARK"
alpha_diversity_clarks$samples <- rownames(alpha_diversity_clarks)
alpha_diversity_clarks$software <- "CLARK-s"

combined_alpha_software <- rbind(alpha_diversity_kraken2, alpha_diversity_clark, alpha_diversity_clarks)

combined_alpha_software_longer <- combined_alpha_software %>% pivot_longer(c("Shannon", "Simpson", "Inverse_Simpson"), names_to = "Alpha Index", values_to = "Index Value")

combined_alpha_software_longer$software <- factor(combined_alpha_software_longer$software, levels=c("Kraken2", "CLARK", "CLARK-s"))
combined_alpha_software_longer$`Alpha Index`<- factor(combined_alpha_software_longer$`Alpha Index`, levels = c("Shannon", "Simpson", "Inverse_Simpson"))

library(ggsignif)
software_alpha_p <- ggplot(combined_alpha_software_longer, aes(x= software, y=`Index Value`))+
  geom_boxplot(alpha=0.1,color="gray")+
  
  geom_point(aes(shape=samples),size=3)+
  scale_shape_manual(values = c(19,18,17,15,seq(1,12,1)))+
  theme_bw()+
  facet_wrap(vars(`Alpha Index`), scales = "free_y")+
  stat_signif(comparisons = list(c("Kraken2", "CLARK"), c("Kraken2", "CLARK-s"), c("CLARK","CLARK-s")), map_signif_level =c("***"=0.001,"**"=0.01,"*"=0.05, " "=2), test ="wilcox.test", position = "identity",test.args = list(paired=T, exact=TRUE), vjust=0.6,
                        textsize=6,
                        size=0.5,
                        step_increase = 0.05, na.rm = TRUE, show.legend = TRUE, fontface = "bold")+ theme(axis.text.x = element_text(angle=45, vjust=0.8,hjust = 0.8, size =12),axis.text.y = element_text(size=12), strip.text = element_text(size=12),axis.title = element_text(size=12), legend.text = element_text(size=12),legend.title = element_text(size=12))+
    scale_y_continuous(labels = comma)+
  labs(y="Alpha Indices Values")
  
 software_alpha_p
ggsave(plot = software_alpha_p, width = 10, height = 6, dpi = 500, filename = "/Users/rx32940/Desktop/software_alpha_boxplot.pdf")

```
## combine beta diversity
```{r}
# 
# df_kraken2 <- as.data.frame(as.matrix(beta_dist_kraken2))
# df_kraken2$Kraken2_1 <- rownames(df_kraken2)
# df_kraken2 <-  df_kraken2 %>% pivot_longer(head(colnames(df_kraken2),length(colnames(df_kraken2))-1), names_to = "Kraken2_2", values_to = "bray curtis index")
# ggplot(df_kraken2, aes(x=Kraken2_1 , y=Kraken2_2, fill=`bray curtis index`))+
#   geom_tile()

library(gplots)
# pdf('/Users/rx32940/Desktop/kraken2_beta_heatmap.pdf')
# heatmap.2(as.matrix(beta_dist_kraken2),key=TRUE, symkey=FALSE, density.info="none", trace="none",key.title = "Bray Curtis Indices",cexRow = 1.6,cexCol = 1.6,margins = c(6,6))
# dev.off()

# pdf('/Users/rx32940/Desktop/clark-s_beta_heatmap.pdf')
# heatmap.2(as.matrix(beta_dist_clarks),key=TRUE, symkey=FALSE, density.info="none", trace="none",cexRow = 1.6,cexCol = 1.6,margins = c(6,6))
# dev.off


```

## Combined differential abundance 
```{r}
sigtax_kraken2_lineage$software <- "Kraken2"
clark_deseq_lineage$software <- "CLARK"
clarks_deseq_lineage$software <- "CLARK-s"

combined_deseq_lineage <- rbind(sigtax_kraken2_lineage, clark_deseq_lineage, clarks_deseq_lineage)

combined_deseq_lineage$software <- factor(combined_deseq_lineage$software, levels= c("Kraken2", "CLARK", "CLARK-s"))
combined_signab_plot <- ggplot(combined_deseq_lineage, aes(x= Genus, y= log2FoldChange))+
  geom_point(aes(shape=Phylum), size=4)+
    scale_shape_manual(values = c(19,18,17,15,seq(1,12,1)))+
  facet_wrap(vars(software), scales = "free_x")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, size =12),axis.text.y = element_text(size=12), strip.text = element_text(size=14),axis.title = element_text(size=14), legend.text = element_text(size=12),legend.title = element_text(size=12), panel.spacing = unit(2,"lines"))

combined_signab_plot

ggsave("/Users/rx32940/Desktop/combined_signab_plot.pdf", combined_signab_plot, width = 14, height=6)

```

### sig different genus kidney vs lung
```{r}
# kraken2
cat("Kraken2:\n")
kraken2_sig_genus
sig_genus_kraken<- rownames(as.data.frame(kraken2_sig_genus))

# clark
cat("Clark:\n")
clark_sig_genus
sig_genus_clark<- rownames(as.data.frame(clark_sig_genus))



#clark-s
cat("Clark-s:\n")
clarks_sig_genus
sig_genus_clarks<- rownames(as.data.frame(clarks_sig_genus))


intersect(intersect(sig_genus_kraken, sig_genus_clark),sig_genus_clarks)

```
### sig different phylum kidney vs lung
```{r}
# kraken2
cat("Kraken2:\n")
kraken2_sig_phylum

# clark
cat("Clark:\n")
clarks_sig_phylum


#clark-s
cat("Clark-s:\n")
clark_sig_phylum

```
### Alpha Diversity
```{r}
# kraken2
cat("Kraken2:\n")
alpha_diversity_kraken2

# clark
cat("Clark:\n")
alpha_diversity_clark


#clark-s
cat("Clark-s:\n")
clark_sig_phylum
alpha_diversity_clarks

```

## if the alpha diversity provided for each sample with different software has a significant difference (Friedman Test)

### Shannon
```{r}
# friedman test
# paired test for more than two paired samples that is not normally distributed
samples <- rep(rownames(alpha_diversity_kraken2),3)

three_alpha <- data.frame(sample_id = samples, software=c(rep("kraken",12),rep("clark",12), rep("clark-s",12)), alpha_index=c(alpha_diversity_kraken2$Shannon,alpha_diversity_clark$Shannon,alpha_diversity_clarks$Shannon))
three_alpha$software <- factor(three_alpha$software, levels=c("kraken","clark","clark-s"))
three_alpha$sample_id <- factor(three_alpha$sample_id, levels = rownames(alpha_diversity_kraken2))
# The null hypothesis is that apart from an effect of blocks, the location parameter of y is the same in each of the groups
friedman.test(alpha_index ~ sample_id | software, data = three_alpha) # (values ~ group | block)

################# wilcoxon test for pair-wise significance test #######################

# wilcoxon, kraken2 vs clark
samples <- rep(rownames(alpha_diversity_kraken2),2)
two_alpha <- data.frame(sample_id= samples, software=c(rep("kraken2",12),rep("clark",12)),alpha_index=c(alpha_diversity_kraken2$Shannon,alpha_diversity_clark$Shannon))
two_alpha$sample_id <- factor(two_alpha$sample_id, levels =unique(samples))
two_alpha$software <- factor(two_alpha$software, levels = c("kraken2","clark"))
wilcox.test(two_alpha$alpha_index ~ two_alpha$software, paired = TRUE) # no rejected

# wilcoxon test for pair-wise significance test
# wilcoxon, kraken2 vs clark
samples <- rep(rownames(alpha_diversity_kraken2),2)
two_alpha <- data.frame(sample_id= samples, software=c(rep("clark",12),rep("clarks",12)),alpha_index=c(alpha_diversity_clark$Shannon,alpha_diversity_clarks$Shannon))
two_alpha$sample_id <- factor(two_alpha$sample_id, levels =unique(samples))
two_alpha$software <- factor(two_alpha$software, levels = c("clark","clarks"))
wilcox.test(two_alpha$alpha_index ~ two_alpha$software, paired = TRUE) # no rejected

# wilcoxon test for pair-wise significance test
# wilcoxon, kraken2 vs clark
samples <- rep(rownames(alpha_diversity_kraken2),2)
two_alpha <- data.frame(sample_id= samples, software=c(rep("kraken2",12),rep("clarks",12)),alpha_index=c(alpha_diversity_kraken2$Shannon,alpha_diversity_clarks$Shannon))
two_alpha$sample_id <- factor(two_alpha$sample_id, levels =unique(samples))
two_alpha$software <- factor(two_alpha$software, levels = c("kraken2","clarks"))
wilcox.test(two_alpha$alpha_index ~ two_alpha$software, paired = TRUE) # no rejected
```

### Simpson
```{r}
# friedman test
# paired test for more than two paired samples that is not normally distributed
samples <- rep(rownames(alpha_diversity_kraken2),3)

three_alpha <- data.frame(sample_id = samples, software=c(rep("kraken",12),rep("clark",12), rep("clark-s",12)), alpha_index=c(alpha_diversity_kraken2$Simpson,alpha_diversity_clark$Simpson,alpha_diversity_clarks$Simpson))
three_alpha$software <- factor(three_alpha$software, levels=c("kraken","clark","clark-s"))
three_alpha$sample_id <- factor(three_alpha$sample_id, levels = rownames(alpha_diversity_kraken2))
# The null hypothesis is that apart from an effect of blocks, the location parameter of y is the same in each of the groups
friedman.test(alpha_index ~ sample_id | software, data = three_alpha) # (values ~ group | block)

################# wilcoxon test for pair-wise significance test #######################

# wilcoxon, kraken2 vs clark
samples <- rep(rownames(alpha_diversity_kraken2),2)
two_alpha <- data.frame(sample_id= samples, software=c(rep("kraken2",12),rep("clark",12)),alpha_index=c(alpha_diversity_kraken2$Simpson,alpha_diversity_clark$Simpson))
two_alpha$sample_id <- factor(two_alpha$sample_id, levels =unique(samples))
two_alpha$software <- factor(two_alpha$software, levels = c("kraken2","clark"))
wilcox.test(two_alpha$alpha_index ~ two_alpha$software, paired = TRUE) # no rejected

# wilcoxon test for pair-wise significance test
# wilcoxon, kraken2 vs clark
samples <- rep(rownames(alpha_diversity_kraken2),2)
two_alpha <- data.frame(sample_id= samples, software=c(rep("clark",12),rep("clarks",12)),alpha_index=c(alpha_diversity_clark$Simpson,alpha_diversity_clarks$Simpson))
two_alpha$sample_id <- factor(two_alpha$sample_id, levels =unique(samples))
two_alpha$software <- factor(two_alpha$software, levels = c("clark","clarks"))
wilcox.test(two_alpha$alpha_index ~ two_alpha$software, paired = TRUE) # no rejected

# wilcoxon test for pair-wise significance test
# wilcoxon, kraken2 vs clark
samples <- rep(rownames(alpha_diversity_kraken2),2)
two_alpha <- data.frame(sample_id= samples, software=c(rep("kraken2",12),rep("clarks",12)),alpha_index=c(alpha_diversity_kraken2$Simpson,alpha_diversity_clarks$Simpson))
two_alpha$sample_id <- factor(two_alpha$sample_id, levels =unique(samples))
two_alpha$software <- factor(two_alpha$software, levels = c("kraken2","clarks"))
wilcox.test(two_alpha$alpha_index ~ two_alpha$software, paired = TRUE) # no rejected
```

### Inverse Simpson
```{r}
# friedman test
# paired test for more than two paired samples that is not normally distributed
samples <- rep(rownames(alpha_diversity_kraken2),3)

three_alpha <- data.frame(sample_id = samples, software=c(rep("kraken",12),rep("clark",12), rep("clark-s",12)), alpha_index=c(alpha_diversity_kraken2$Inverse_Simpson,alpha_diversity_clark$Inverse_Simpson,alpha_diversity_clarks$Inverse_Simpson))
three_alpha$software <- factor(three_alpha$software, levels=c("kraken","clark","clark-s"))
three_alpha$sample_id <- factor(three_alpha$sample_id, levels = rownames(alpha_diversity_kraken2))
# The null hypothesis is that apart from an effect of blocks, the location parameter of y is the same in each of the groups
friedman.test(alpha_index ~ sample_id | software, data = three_alpha) # (values ~ group | block)

################# wilcoxon test for pair-wise significance test #######################

# wilcoxon, kraken2 vs clark
samples <- rep(rownames(alpha_diversity_kraken2),2)
two_alpha <- data.frame(sample_id= samples, software=c(rep("kraken2",12),rep("clark",12)),alpha_index=c(alpha_diversity_kraken2$Inverse_Simpson,alpha_diversity_clark$Inverse_Simpson))
two_alpha$sample_id <- factor(two_alpha$sample_id, levels =unique(samples))
two_alpha$software <- factor(two_alpha$software, levels = c("kraken2","clark"))
wilcox.test(two_alpha$alpha_index ~ two_alpha$software, paired = TRUE) # no rejected

# wilcoxon test for pair-wise significance test
# wilcoxon, kraken2 vs clark
samples <- rep(rownames(alpha_diversity_kraken2),2)
two_alpha <- data.frame(sample_id= samples, software=c(rep("clark",12),rep("clarks",12)),alpha_index=c(alpha_diversity_clark$Inverse_Simpson,alpha_diversity_clarks$Inverse_Simpson))
two_alpha$sample_id <- factor(two_alpha$sample_id, levels =unique(samples))
two_alpha$software <- factor(two_alpha$software, levels = c("clark","clarks"))
wilcox.test(two_alpha$alpha_index ~ two_alpha$software, paired = TRUE) # no rejected

# wilcoxon test for pair-wise significance test
# wilcoxon, kraken2 vs clark
samples <- rep(rownames(alpha_diversity_kraken2),2)
two_alpha <- data.frame(sample_id= samples, software=c(rep("kraken2",12),rep("clarks",12)),alpha_index=c(alpha_diversity_kraken2$Inverse_Simpson,alpha_diversity_clarks$Inverse_Simpson))
two_alpha$sample_id <- factor(two_alpha$sample_id, levels =unique(samples))
two_alpha$software <- factor(two_alpha$software, levels = c("kraken2","clarks"))
wilcox.test(two_alpha$alpha_index ~ two_alpha$software, paired = TRUE) # no rejected
```

### Beta_Diversity

```{r}
# kraken2
cat("Kraken2:\n")
beta_dist_kraken2

# clark
cat("Clark:\n")
beta_dist_clark


#clark-s
cat("Clark-s:\n")
clark_sig_phylum
beta_dist_clarks

```

### Friedman test for beta diversities (bray indices) from Kraken2, Clark and Clark-S
```{r}
# friedman test
# paired test for more than two paired samples that is not normally distributed
between_samples <- as.character(rep(seq(1:66),3)) # use number as index to represent pairwise relationships

# convert distance matrix to vector from top to bottom row by row
beta_dist_kraken2_matrix <- as.matrix(beta_dist_kraken2)
kraken2_beta_vector <- beta_dist_kraken2_matrix[lower.tri(beta_dist_kraken2_matrix)][order(row(beta_dist_kraken2_matrix)[lower.tri(row(beta_dist_kraken2_matrix))])]
# convert distance matrix to vector from top to bottom row by row
beta_dist_clark_matrix <- as.matrix(beta_dist_clark)
clark_beta_vector <- beta_dist_clark_matrix[lower.tri(beta_dist_clark_matrix)][order(row(beta_dist_clark_matrix)[lower.tri(row(beta_dist_clark_matrix))])]
# convert distance matrix to vector from top to bottom row by row
beta_dist_clarks_matrix <- as.matrix(beta_dist_clarks)
clarks_beta_vector <- beta_dist_clarks_matrix[lower.tri(beta_dist_clarks_matrix)][order(row(beta_dist_clarks_matrix)[lower.tri(row(beta_dist_clarks_matrix))])]

three_beta <- data.frame(compare_id = between_samples, software=c(rep("kraken",66),rep("clark",66), rep("clark-s",66)), beta_index=c(kraken2_beta_vector,clark_beta_vector,clarks_beta_vector))
three_beta$software <- factor(three_beta$software, levels=c("kraken","clark","clark-s"))
three_beta$compare_id <- factor(three_beta$compare_id, levels = as.character(seq(1:66)))
# The null hypothesis is that apart from an effect of blocks, the location parameter of y is the same in each of the groups
friedman.test(beta_index ~ compare_id | software, data = three_beta) # (values ~ group | block)

################# wilcoxon test for pair-wise significance test #######################

between_samples <- as.character(rep(seq(1:66),2)) # use number as index to represent pairwise relationships
# wilcoxon, kraken2 vs clark

two_beta <- data.frame(sample_id= between_samples, software=c(rep("kraken2",66),rep("clark",66)),beta_index=c(kraken2_beta_vector,clark_beta_vector))
two_beta$sample_id <- factor(two_beta$sample_id, levels =as.character(seq(1:66)))
two_beta$software <- factor(two_beta$software, levels = c("kraken2","clark"))
wilcox.test(two_beta$beta_index ~ two_beta$software, paired = TRUE) # no rejected

# wilcoxon test for pair-wise significance test
# wilcoxon, kraken2 vs clark

two_beta <- data.frame(sample_id= between_samples, software=c(rep("clark",66),rep("clarks",66)),beta_index=c(clark_beta_vector,clarks_beta_vector))
two_beta$sample_id <- factor(two_beta$sample_id, levels =as.character(seq(1:66)))
two_beta$software <- factor(two_beta$software, levels = c("clark","clarks"))
wilcox.test(two_beta$beta_index ~ two_beta$software, paired = TRUE) # no rejected

# wilcoxon test for pair-wise significance test
# wilcoxon, kraken2 vs clark

two_beta <- data.frame(sample_id= between_samples, software=c(rep("kraken2",66),rep("clarks",66)),beta_index=c(kraken2_beta_vector,clarks_beta_vector))
two_beta$sample_id <- factor(two_beta$sample_id, levels =as.character(seq(1:66)))
two_beta$software <- factor(two_beta$software, levels = c("kraken2","clarks"))
wilcox.test(two_beta$beta_index ~ two_beta$software, paired = TRUE) # no rejected


```
